#!/usr/bin/env bash
basedir=/home/work/vm/win11
diskdir=$(realpath $basedir/win11_202307.qcow2)
diskdata=$(realpath $basedir/win11_202410_data.qcow2)
sharedir=$(realpath ~/share)
mem_size=6G
pidfile="/tmp/.vm.win11.pid"
prefix_name=vmwrk-w11
cmd_notify="notify-send -u normal 'VM($prefix_name)' -t 2000"

gen_random_value() {
    val=$(echo "$RANDOM % 10000 + 1" | awk '{printf "%.4d", $0}')
    echo $val
}

#startup_clients() {
#    vncviewer -FullScreen -Maximize −CompressLevel 6 \
#        -EmulateMiddleButton −RemoteResize $1 2>/dev/null 
#}

## prepare virtiofsd share directory
rnd_val=$(gen_random_value)
workingdir=/tmp/.$prefix_name.$rnd_val
virtiofsd_dir_base=$workingdir/.fsmounts
current_shortcut_path=/tmp/.$prefix_name.current

mkdir -p $virtiofsd_dir_base/{host-tmp,host-doc,host-app}

## generate setup.sh to workspace and run it in container
setup_file_path=$workingdir/env-setup.sh
cat > $setup_file_path << EOF
#!/usr/bin/env bash
# Generated by script
mount -o bind /tmp $virtiofsd_dir_base/host-tmp
mount -o bind,ro $HOME/Documents $virtiofsd_dir_base/host-doc
mount -o bind $HOME/Documents/40appData $virtiofsd_dir_base/host-app
## end

# create shortcut for working dir
test -L $current_shortcut_path && rm $current_shortcut_path
ln -svf $workingdir $current_shortcut_path > /dev/null 
EOF

## check qemu start ?
if [ -f $pidfile ];then 
    echo -e "PID $(cat $pidfile) exists, should make sure it is stopped.\nClean the mounts:\n\t"
    mount -l | grep -rE "$prefix_name"
    exit 1
fi

## start virtiofsd daemon
log_dir=$workingdir/logs
virtiofs_pidfile=$workingdir/.virtiofsd.pid
virtiofsd_sock_path=$workingdir/virtiofsd.sock
mkdir -p $log_dir

echo "Starting Virtiofs."
 
while [ -z "$(podman unshare sh $setup_file_path; podman unshare mount -l | grep host)" ]
do
    sleep 1
done

nohup podman unshare /usr/libexec/virtiofsd \
    --socket-path=$virtiofsd_sock_path \
    --shared-dir $virtiofsd_dir_base \
    --announce-submounts --sandbox chroot \
    > $log_dir/virtiofsd.log 2>&1 & 


#### save pid to file
echo $! > $virtiofs_pidfile

while [ -z "$(grep -i 'waiting' $log_dir/virtiofsd.log)" ]
do
    sleep 1
done


echo "Virtiofs Started($(cat $virtiofs_pidfile))."

#vnc_unix_sock="$workingdir/vnc.sock"
## start client first
#echo "Starting VM client."
#startup_clients &

## start qemu
echo "Starting VM($rnd_val)."

if [ ! -z "$NOTIFY_SND" ]; then
    $cmd_notify "VM($rnd_val) Start."
fi

QEMU_OPTS=
# Basic VM
QEMU_OPTS="$QEMU_OPTS --enable-kvm --name win11 -pidfile $pidfile"
QEMU_OPTS="$QEMU_OPTS -machine q35,accel=kvm,vmport=off,hmat=on"
QEMU_OPTS="$QEMU_OPTS -boot c -rtc base=localtime -k en-us"
QEMU_OPTS="$QEMU_OPTS -qmp unix:$workingdir/qmp-shell.sock,server=on,wait=off"
# Basic CPU
QEMU_OPTS="$QEMU_OPTS -cpu host,hv-relaxed,hv-frequencies,hv-reenlightenment,migratable=off"
QEMU_OPTS="$QEMU_OPTS -smp sockets=1,cores=4,threads=1"
# memory
QEMU_OPTS="$QEMU_OPTS -m $mem_size"
# Drive 
QEMU_OPTS="$QEMU_OPTS -drive file=${diskdir},format=qcow2,media=disk,cache=writethrough,aio=io_uring"
QEMU_OPTS="$QEMU_OPTS -drive file=${diskdata},format=qcow2,media=disk,cache=writethrough,aio=io_uring"
# Dispaly 
QEMU_OPTS="$QEMU_OPTS -display gtk,zoom-to-fit=on,full-screen=off,gl=on,grab-on-hover=off,window-close=on,show-menubar=off"
QEMU_OPTS="$QEMU_OPTS -vga virtio"
# Netowrk
## NAT net
QEMU_OPTS="$QEMU_OPTS -nic user,model=virtio-net-pci"
# USB
QEMU_OPTS="$QEMU_OPTS -device qemu-xhci,id=xhci"
QEMU_OPTS="$QEMU_OPTS -usbdevice tablet"
# Audio
QEMU_OPTS="$QEMU_OPTS -audiodev pipewire,id=audio0"
QEMU_OPTS="$QEMU_OPTS -device intel-hda -device hda-duplex,audiodev=audio0"
# Vdagent for clipboard sharing
QEMU_OPTS="$QEMU_OPTS -device virtio-serial,packed=on,ioeventfd=on"
QEMU_OPTS="$QEMU_OPTS -device virtserialport,name=com.redhat.spice.0,chardev=vdagent0"
QEMU_OPTS="$QEMU_OPTS -chardev qemu-vdagent,id=vdagent0,name=vdagent,clipboard=on,mouse=off"
# VirtioFS
QEMU_OPTS="$QEMU_OPTS -chardev socket,id=char0,path=${virtiofsd_sock_path}"
QEMU_OPTS="$QEMU_OPTS -device vhost-user-fs-pci,queue-size=1024,chardev=char0,tag=host-share"
QEMU_OPTS="$QEMU_OPTS -object memory-backend-memfd,id=mem0,size=$mem_size"
## check hugepagetbl is on
if [ ! -z "$(grep -i 'default_hugepagesz' /proc/cmdline)" ]; then
    hugepagesz=$(sed -r 's/^.+\s+hugepagesz=(.+)\s+.+$/\1/ig' /proc/cmdline)
    QEMU_OPTS="$QEMU_OPTS,hugetlb=on,hugetlbsize=$hugepagesz"
fi
QEMU_OPTS="$QEMU_OPTS -numa node,memdev=mem0,nodeid=0" 
QEMU_OPTS="$QEMU_OPTS -numa cpu,node-id=0,socket-id=0,core-id=0" 
QEMU_OPTS="$QEMU_OPTS -numa cpu,node-id=0,socket-id=0,core-id=1" 
QEMU_OPTS="$QEMU_OPTS -numa cpu,node-id=0,socket-id=0,core-id=2" 
QEMU_OPTS="$QEMU_OPTS -numa cpu,node-id=0,socket-id=0,core-id=3" 

QEMU_OPTS="$QEMU_OPTS $@"
echo -e "VM Run as:\n\t $QEMU_OPTS"
# TODO current nvidia offload not work with gtk gl=on 2025.07.08
__NV_PRIME_RENDER_OFFLOAD=0 taskset -c 4-7 qemu-system-x86_64 $QEMU_OPTS > $log_dir/qemu.log 2>&1

rm $pidfile > /dev/null 2>&1
## echo quit
echo "VM Quit with code($?)."


### clean virtiofs daemon
kill -3 $(cat $virtiofs_pidfile) > /dev/null 2>&1
podman unshare mount -l | grep -i $prefix_name | cut -d ' ' -f 3 | tr -d ' ' | xargs -I{} podman unshare umount {}
echo "Virtiofs Daemon Quit ."

if [ ! -z "$NOTIFY_SND" ]; then
    $cmd_notify "VM($rnd_val) Quit."
fi

### backup
  #-display gtk,zoom-to-fit=on -vga vmware 
    # sound card
    #-soundhw hda \
  #-device intel-hda -device hda-duplex,audiodev=hda \
  #-audiodev alsa,id=hda,out.frequency=48000,in.frequency=48000,in.buffer-length=20000,out.buffer-length=20000 \
  #-usbdevice tablet \
  #-device qemu-xhci,id=xhci \
  #-device usb-host,vendorid=0x05ac,productid=0x12a8 \
  #-device usb-host,vendorid=0x1ff7,productid=0x0200 \
  #-device usb-host,vendorid=0x05ac,productid=0x12a8 \
  ## ,p2=15,p3=12
  #
### boot install iso
  #-drive file=/home/work/Downloads/G_WIN11_X64_22621.1928JJ.iso,media=cdrom,index=2 \
  #-drive index=1,file=/home/work/vm/win11/WePE_64_V2.3.iso,media=cdrom \
  #-boot d
  #\
  #-chardev socket,id=char0,path=/tmp/vfsd-qemu-doc.sock \
  #-device vhost-user-fs-pci,queue-size=1024,chardev=char0,tag=docfs \
  #-object memory-backend-file,id=mem,size=8G,mem-path=/dev/shm,share=on \
  #-numa node,memdev=mem  \
  # virtiofsd --syslog  --shared-dir /home/work/Documents --socket-path /tmp/vfsd-win11-doc.sock --socket-group work

  ### spice
  #-vga qxl \
  #-spice port=3001,disable-ticketing=on \
  #-device virtio-serial -chardev spicevmc,id=vdagent,debug=0,name=vdagent \
  #-device virtserialport,chardev=vdagent,name=com.redhat.spice.0 \

  ### vnc
  #-vnc unix:${vnc_unix_sock},power-control=on \
  #-vnc unix:${vnc_unix_sock},power-control=on,share=allow-exclusive,lossy=on \

  ### rdp
  # -display none
  # ,hostfwd=udp:127.0.0.1:13389-:3389,hostfwd=tcp:127.0.0.1:13389-:3389
  #-nic user,model=virtio,hostfwd=udp:127.0.0.1:3389-:3389,hostfwd=tcp:127.0.0.1:3389-:3389 \


### images
## qemu-img create -f qcow2 -o compression_type=zstd,preallocation=full win11_202410_data.qcow2 20G


### clipboard sync qemu-vdagent gtk enable-gtk-clipboard
  #-device virtio-serial,packed=on,ioeventfd=on \
  #-device virtserialport,name=com.redhat.spice.0,chardev=vdagent0 \
  #-chardev qemu-vdagent,id=vdagent0,name=vdagent,clipboard=on,mouse=off \
